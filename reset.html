<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nevro AI — استعادة كلمة المرور</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;900&family=Syne:wght@700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root{
  --bg:#07091a;--bg2:#0c1124;
  --surface:rgba(255,255,255,0.04);--border:rgba(255,255,255,0.08);--bh:rgba(99,179,237,0.35);
  --cyan:#63b3ed;--cgl:rgba(99,179,237,0.15);--purple:#9f7aea;--pink:#f687b3;
  --err:#fc8181;--ok:#68d391;
  --text:#eef2ff;--text2:rgba(238,242,255,0.55);--text3:rgba(238,242,255,0.30);
}
[data-theme="light"]{
  --bg:#f6f8fc;--bg2:#edf1f9;
  --surface:rgba(0,0,0,0.03);--border:rgba(0,0,0,0.08);--bh:rgba(37,99,235,0.3);
  --cyan:#2563eb;--cgl:rgba(37,99,235,0.1);--purple:#6d28d9;
  --text:#111827;--text2:rgba(17,24,39,0.6);--text3:rgba(17,24,39,0.35);
}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Tajawal',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;display:flex;align-items:center;justify-content:center;overflow:hidden;transition:background .3s,color .3s;}
#bgCanvas{position:fixed;inset:0;z-index:0;pointer-events:none;opacity:.4;}
[data-theme="light"] #bgCanvas{opacity:.12;}

/* TOP NAV */
.top-nav{position:fixed;top:0;left:0;right:0;display:flex;align-items:center;justify-content:space-between;padding:18px 40px;z-index:10;}
.brand{display:flex;align-items:center;gap:10px;text-decoration:none;}
.brand-logo{width:32px;height:32px;border-radius:9px;overflow:hidden;box-shadow:0 0 12px var(--cgl);}
.brand-logo img{width:100%;height:100%;object-fit:cover;}
.brand-name{font-family:'Syne',sans-serif;font-size:17px;font-weight:800;background:linear-gradient(100deg,var(--cyan) 30%,var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.nav-r{display:flex;align-items:center;gap:8px;}
.btn-theme{width:32px;height:32px;border-radius:50%;border:1px solid var(--border);background:var(--surface);color:var(--text2);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;}
.btn-theme:hover{border-color:var(--cyan);color:var(--cyan);}
.btn-back{display:flex;align-items:center;gap:6px;padding:7px 14px;border-radius:999px;border:1px solid var(--border);background:transparent;color:var(--text2);font-size:13px;font-family:'Tajawal',sans-serif;cursor:pointer;transition:all .2s;}
.btn-back:hover{border-color:var(--bh);color:var(--text);}
.btn-back svg{width:14px;height:14px;}

/* CENTER CARD */
.card-wrap{position:relative;z-index:1;width:100%;max-width:420px;padding:24px;}

/* steps indicator */
.steps-bar{display:flex;align-items:center;justify-content:center;gap:0;margin-bottom:36px;}
.step-item{display:flex;align-items:center;gap:0;}
.step-dot{width:32px;height:32px;border-radius:50%;border:2px solid var(--border);background:var(--surface);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:var(--text3);transition:all .4s;flex-shrink:0;}
.step-dot.active{border-color:var(--cyan);background:var(--cgl);color:var(--cyan);}
.step-dot.done{border-color:var(--ok);background:rgba(104,211,145,0.15);color:var(--ok);}
.step-dot.done svg{width:14px;height:14px;}
.step-line{width:48px;height:2px;background:var(--border);transition:background .4s;}
.step-line.done{background:var(--ok);}

/* card */
.panel{background:var(--bg2);border:1px solid var(--border);border-radius:24px;padding:36px;box-shadow:0 24px 60px rgba(0,0,0,.35),0 0 0 1px rgba(255,255,255,.04);opacity:0;animation:fadeUp .5s .1s forwards;}
[data-theme="light"] .panel{box-shadow:0 24px 60px rgba(0,0,0,.1);}

/* icon */
.panel-icon{width:56px;height:56px;border-radius:16px;background:linear-gradient(135deg,var(--cyan),var(--purple));display:flex;align-items:center;justify-content:center;margin-bottom:20px;box-shadow:0 0 24px var(--cgl);}
.panel-icon svg{width:26px;height:26px;color:#fff;}
.panel-icon.ok-icon{background:linear-gradient(135deg,var(--ok),#38a169);}

.panel-title{font-family:'Syne',sans-serif;font-size:22px;font-weight:800;margin-bottom:8px;}
.panel-sub{font-size:14px;color:var(--text2);line-height:1.65;margin-bottom:24px;}
.panel-sub strong{color:var(--cyan);}

/* alert */
.alert{display:none;padding:11px 15px;border-radius:11px;font-size:13px;margin-bottom:16px;border:1px solid;align-items:center;gap:9px;}
.alert.show{display:flex;}
.alert.err{background:rgba(252,129,129,0.1);border-color:rgba(252,129,129,0.3);color:var(--err);}
.alert.ok{background:rgba(104,211,145,0.1);border-color:rgba(104,211,145,0.3);color:var(--ok);}
.alert svg{width:15px;height:15px;flex-shrink:0;}

/* form */
.fg{margin-bottom:16px;}
.fg label{display:block;font-size:13px;font-weight:600;color:var(--text2);margin-bottom:7px;}
.inp-wrap{position:relative;}
.inp{width:100%;padding:12px 44px 12px 14px;background:var(--surface);border:1px solid var(--border);border-radius:12px;color:var(--text);font-family:'Tajawal',sans-serif;font-size:14px;outline:none;transition:all .25s;direction:rtl;}
.inp:focus{border-color:var(--bh);box-shadow:0 0 0 3px var(--cgl);}
.inp.ok-inp{border-color:var(--ok);}
.inp.err-inp{border-color:var(--err);box-shadow:0 0 0 3px rgba(252,129,129,0.12);}
.inp::placeholder{color:var(--text3);}
.inp-with-toggle{padding-left:44px;}
.inp-icon{position:absolute;top:50%;right:14px;transform:translateY(-50%);color:var(--text3);pointer-events:none;}
.inp-icon svg{width:16px;height:16px;}
.inp-toggle{position:absolute;top:50%;left:14px;transform:translateY(-50%);background:none;border:none;color:var(--text3);cursor:pointer;display:flex;align-items:center;transition:color .2s;}
.inp-toggle:hover{color:var(--cyan);}
.inp-toggle svg{width:16px;height:16px;}

/* strength */
.strength-bar{height:3px;border-radius:2px;background:var(--border);overflow:hidden;margin-top:8px;}
.strength-fill{height:100%;border-radius:2px;width:0;transition:width .35s,background .35s;}
.strength-txt{font-size:11px;color:var(--text3);margin-top:4px;}

/* submit */
.submit-btn{width:100%;padding:13px;border-radius:12px;background:linear-gradient(135deg,var(--cyan),var(--purple));border:none;color:#fff;font-size:15px;font-weight:700;font-family:'Tajawal',sans-serif;cursor:pointer;box-shadow:0 6px 22px var(--cgl);transition:all .3s;display:flex;align-items:center;justify-content:center;gap:9px;margin-top:4px;}
.submit-btn:hover{transform:translateY(-2px);box-shadow:0 10px 28px var(--cgl);}
.submit-btn:disabled{opacity:.7;cursor:not-allowed;transform:none;}

.spinner{width:16px;height:16px;border-radius:50%;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;animation:spin .7s linear infinite;display:none;}
@keyframes spin{to{transform:rotate(360deg)}}

.helper-link{display:block;text-align:center;font-size:13px;color:var(--text3);margin-top:18px;}
.helper-link a{color:var(--cyan);text-decoration:none;font-weight:600;}
.helper-link a:hover{text-decoration:underline;}

@keyframes fadeUp{from{opacity:0;transform:translateY(22px)}to{opacity:1;transform:translateY(0)}}
@media(max-width:500px){.card-wrap{padding:16px;}.panel{padding:28px 22px;}.top-nav{padding:16px 20px;}}
</style>
</head>
<body>
<canvas id="bgCanvas"></canvas>

<!-- Top Nav -->
<div class="top-nav">
  <a class="brand" href="index.html">
    <div class="brand-logo">
      <img src="img/logo.png" alt="Nevro AI" onerror="this.parentElement.innerHTML='<svg viewBox=\'0 0 32 32\' fill=\'none\'><rect width=\'32\' height=\'32\' rx=\'9\' fill=\'url(#gr)\'/><defs><linearGradient id=\'gr\' x1=\'0\' y1=\'0\' x2=\'32\' y2=\'32\'><stop stop-color=\'#63b3ed\'/><stop offset=\'1\' stop-color=\'#9f7aea\'/></linearGradient></defs><path d=\'M10 22L16 10l6 12\' stroke=\'white\' stroke-width=\'2\' stroke-linecap=\'round\' stroke-linejoin=\'round\'/></svg>'">
    </div>
    <span class="brand-name">Nevro AI</span>
  </a>
  <div class="nav-r">
    <button class="btn-theme" id="themeBtn" onclick="toggleTheme()">
      <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 12.79A9 9 0 1111.21 3a7 7 0 009.79 9.79z"/></svg>
    </button>
    <button class="btn-back" onclick="location.href='login.html'">
      <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>
      تسجيل الدخول
    </button>
  </div>
</div>

<!-- Main Card -->
<div class="card-wrap">

  <!-- Steps -->
  <div class="steps-bar">
    <div class="step-item">
      <div class="step-dot active" id="dot1">1</div>
    </div>
    <div class="step-line" id="line1"></div>
    <div class="step-item">
      <div class="step-dot" id="dot2">2</div>
    </div>
    <div class="step-line" id="line2"></div>
    <div class="step-item">
      <div class="step-dot" id="dot3">3</div>
    </div>
  </div>

  <!-- ── STEP 1: Enter email ── -->
  <div class="panel" id="step1">
    <div class="panel-icon">
      <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
    </div>
    <div class="panel-title">نسيت كلمة المرور؟</div>
    <div class="panel-sub">أدخل بريدك الإلكتروني وسنرسل لك رابطاً لاستعادة كلمة المرور.</div>

    <div class="alert" id="alertS1">
      <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
      <span id="alertS1Msg"></span>
    </div>

    <div class="fg">
      <label>البريد الإلكتروني</label>
      <div class="inp-wrap">
        <input type="email" class="inp" id="emailInp" placeholder="example@email.com" autocomplete="email" oninput="validateEmail(this)">
        <span class="inp-icon"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg></span>
      </div>
    </div>

    <button class="submit-btn" id="sendBtn" onclick="sendReset()">
      <span id="sendTxt">إرسال رابط الاستعادة</span>
      <div class="spinner" id="sendSpin"></div>
    </button>

    <div class="helper-link">تذكرت كلمة المرور؟ <a href="login.html">تسجيل الدخول</a></div>
  </div>

  <!-- ── STEP 2: Check email ── -->
  <div id="step2" style="display:none">
    <div class="panel" style="text-align:center;display:flex;flex-direction:column;align-items:center;gap:16px;">
      <div class="panel-icon">
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
      </div>
      <div class="panel-title">تحقق من بريدك</div>
      <div class="panel-sub" style="text-align:center">
        أرسلنا رابط الاستعادة إلى<br>
        <strong id="sentTo"></strong><br><br>
        الرابط صالح لمدة 60 دقيقة. تحقق من مجلد البريد العشوائي إذا لم يصل.
      </div>

      <!-- countdown -->
      <div style="display:flex;align-items:center;gap:8px;font-size:13px;color:var(--text3);">
        <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
        إعادة الإرسال بعد <span id="countdown" style="color:var(--cyan);font-weight:700;margin:0 3px">60</span> ثانية
      </div>

      <button class="submit-btn" id="resendBtn" disabled onclick="resendReset()" style="max-width:260px">
        <span id="resendTxt">إعادة إرسال الرابط</span>
        <div class="spinner" id="resendSpin"></div>
      </button>

      <div class="helper-link"><a href="login.html">العودة لتسجيل الدخول</a></div>
    </div>
  </div>

  <!-- ── STEP 3: New password (when redirected from email link) ── -->
  <div id="step3" style="display:none">
    <div class="panel">
      <div class="panel-icon ok-icon">
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
      </div>
      <div class="panel-title">تعيين كلمة مرور جديدة</div>
      <div class="panel-sub">اختر كلمة مرور قوية لحماية حسابك.</div>

      <div class="alert" id="alertS3">
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
        <span id="alertS3Msg"></span>
      </div>

      <div class="fg">
        <label>كلمة المرور الجديدة</label>
        <div class="inp-wrap">
          <input type="password" class="inp inp-with-toggle" id="newPass" placeholder="8 أحرف على الأقل" oninput="checkStrength(this.value)">
          <span class="inp-icon"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg></span>
          <button class="inp-toggle" onclick="togglePass('newPass','eye1')" type="button" id="eye1">
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
          </button>
        </div>
        <div class="strength-bar"><div class="strength-fill" id="sf"></div></div>
        <div class="strength-txt" id="st"></div>
      </div>

      <div class="fg">
        <label>تأكيد كلمة المرور</label>
        <div class="inp-wrap">
          <input type="password" class="inp inp-with-toggle" id="confPass" placeholder="أعد كتابة كلمة المرور" oninput="checkMatch()">
          <span class="inp-icon"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg></span>
          <button class="inp-toggle" onclick="togglePass('confPass','eye2')" type="button" id="eye2">
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
          </button>
        </div>
      </div>

      <button class="submit-btn" id="updateBtn" onclick="updatePassword()">
        <span id="updateTxt">تحديث كلمة المرور</span>
        <div class="spinner" id="updateSpin"></div>
      </button>
    </div>
  </div>

</div><!-- /card-wrap -->

<script>
const SUPABASE_URL = 'https://nhykoxjgtilnqgnmehkm.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5oeWtveGpndGlsbnFnbm1laGttIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE3MDIwMDMsImV4cCI6MjA4NzI3ODAwM30.DCV36AHiWKYIeB62ZjG-zdz_k7FtyaYVkyQXpE3SP-s';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ── Detect if coming from reset email link ── */
// الطريقة الصح: onAuthStateChange بيستقبل الـ token تلقائياً
sb.auth.onAuthStateChange((event, session) => {
  if (event === 'PASSWORD_RECOVERY') {
    goStep(3);
  }
});
// fallback لو الـ hash موجود
(async () => {
  const hash = window.location.hash;
  if (hash.includes('type=recovery') || hash.includes('access_token')) {
    await sb.auth.getSession();
    goStep(3);
  }
})();

/* ── STEP 1: Send reset email ── */
async function sendReset() {
  const email = document.getElementById('emailInp').value.trim();
  if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
    showAlert('alertS1', 'alertS1Msg', 'يرجى إدخال بريد إلكتروني صحيح', 'err'); return;
  }
  setLoading('sendBtn','sendSpin','sendTxt', true);
  const { error } = await sb.auth.resetPasswordForEmail(email, {
    redirectTo: window.location.origin + '/reset.html'
  });
  setLoading('sendBtn','sendSpin','sendTxt', false);
  if (error) {
    showAlert('alertS1','alertS1Msg', 'حدث خطأ، يرجى المحاولة مجدداً', 'err');
  } else {
    document.getElementById('sentTo').textContent = email;
    goStep(2);
    startCountdown();
  }
}

/* ── STEP 2: Resend ── */
async function resendReset() {
  const email = document.getElementById('emailInp').value.trim();
  if (!email) return;
  setLoading('resendBtn','resendSpin','resendTxt', true);
  await sb.auth.resetPasswordForEmail(email, { redirectTo: window.location.origin + '/reset.html' });
  setLoading('resendBtn','resendSpin','resendTxt', false);
  document.getElementById('resendBtn').disabled = true;
  startCountdown();
}

/* ── STEP 3: Update password ── */
async function updatePassword() {
  const pass = document.getElementById('newPass').value;
  const conf = document.getElementById('confPass').value;
  if (pass.length < 8) { showAlert('alertS3','alertS3Msg','كلمة المرور يجب أن تكون 8 أحرف على الأقل','err'); return; }
  if (pass !== conf)   { showAlert('alertS3','alertS3Msg','كلمات المرور غير متطابقة','err'); return; }
  setLoading('updateBtn','updateSpin','updateTxt', true);
  const { error } = await sb.auth.updateUser({ password: pass });
  setLoading('updateBtn','updateSpin','updateTxt', false);
  if (error) {
    showAlert('alertS3','alertS3Msg', 'حدث خطأ، يرجى المحاولة مجدداً', 'err');
  } else {
    showAlert('alertS3','alertS3Msg', 'تم تحديث كلمة المرور! جاري التحويل...', 'ok');
    setTimeout(() => location.href = 'dashboard.html', 1800);
  }
}

/* ── Helpers ── */
function goStep(n) {
  ['step1','step2','step3'].forEach((id,i) => {
    document.getElementById(id).style.display = i+1===n ? 'block' : 'none';
  });
  // update dots
  for(let i=1;i<=3;i++){
    const dot = document.getElementById('dot'+i);
    dot.className = 'step-dot' + (i < n ? ' done' : i === n ? ' active' : '');
    if(i < n) dot.innerHTML = `<svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>`;
    else dot.textContent = i;
  }
  for(let i=1;i<=2;i++){
    const line = document.getElementById('line'+i);
    line.className = 'step-line' + (i < n ? ' done' : '');
  }
}

function startCountdown() {
  let t = 60;
  const el = document.getElementById('countdown');
  const btn = document.getElementById('resendBtn');
  btn.disabled = true;
  const iv = setInterval(() => {
    t--;
    if(el) el.textContent = t;
    if(t <= 0) { clearInterval(iv); btn.disabled = false; if(el) el.textContent = '0'; }
  }, 1000);
}

function validateEmail(inp) {
  const ok = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(inp.value);
  inp.className = 'inp' + (inp.value ? (ok ? ' ok-inp' : ' err-inp') : '');
}

function checkStrength(v) {
  const sf=document.getElementById('sf'),st=document.getElementById('st');
  let s=0;
  if(v.length>=8)s++;if(/[A-Z]/.test(v))s++;if(/[0-9]/.test(v))s++;if(/[^A-Za-z0-9]/.test(v))s++;
  const L=[{w:'25%',b:'#fc8181',t:'ضعيفة'},{w:'50%',b:'#f6ad55',t:'متوسطة'},{w:'75%',b:'#68d391',t:'جيدة'},{w:'100%',b:'#38a169',t:'قوية جداً'}];
  const l=L[Math.max(0,s-1)];
  sf.style.width=v?l.w:'0';sf.style.background=l.b;
  st.textContent=v?'قوة كلمة المرور: '+l.t:'';st.style.color=l.b;
}

function checkMatch() {
  const p1=document.getElementById('newPass').value;
  const p2=document.getElementById('confPass');
  p2.className='inp inp-with-toggle'+(p2.value?(p1===p2.value?' ok-inp':' err-inp'):'');
}

function togglePass(id,btnId){
  const inp=document.getElementById(id),isP=inp.type==='password';
  inp.type=isP?'text':'password';
  document.getElementById(btnId).innerHTML=isP
    ?`<svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8"><path stroke-linecap="round" stroke-linejoin="round" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"/></svg>`
    :`<svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>`;
}

function setLoading(btnId,spId,txtId,on){
  document.getElementById(btnId).disabled=on;
  document.getElementById(spId).style.display=on?'block':'none';
  document.getElementById(txtId).style.opacity=on?'0':'1';
}

function showAlert(boxId,msgId,msg,type){
  const box=document.getElementById(boxId);
  box.className=`alert ${type} show`;
  document.getElementById(msgId).textContent=msg;
}

function toggleTheme(){
  const light=document.body.getAttribute('data-theme')!=='light';
  document.body.setAttribute('data-theme',light?'light':'');
  document.getElementById('themeBtn').innerHTML=light
    ?`<svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>`
    :`<svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 12.79A9 9 0 1111.21 3a7 7 0 009.79 9.79z"/></svg>`;
}

/* Enter key */
document.addEventListener('keydown',e=>{if(e.key==='Enter'){const s1=document.getElementById('step1');if(s1.style.display!=='none')sendReset();}});

/* Canvas */
(function(){
  const cv=document.getElementById('bgCanvas'),cx=cv.getContext('2d');let W,H;
  function r(){W=cv.width=innerWidth;H=cv.height=innerHeight;}r();window.addEventListener('resize',r);
  const C=['#63b3ed','#9f7aea','#f687b3'];
  const P=Array.from({length:35},()=>({x:Math.random()*innerWidth,y:Math.random()*innerHeight,vx:(Math.random()-.5)*.15,vy:(Math.random()-.5)*.15,r:Math.random()*1.2+.3,c:C[~~(Math.random()*3)],a:Math.random()*.35+.08}));
  (function d(){cx.clearRect(0,0,W,H);P.forEach(p=>{p.x+=p.vx;p.y+=p.vy;if(p.x<0)p.x=W;if(p.x>W)p.x=0;if(p.y<0)p.y=H;if(p.y>H)p.y=0;cx.beginPath();cx.arc(p.x,p.y,p.r,0,Math.PI*2);cx.fillStyle=p.c;cx.globalAlpha=p.a;cx.fill();});for(let i=0;i<P.length;i++)for(let j=i+1;j<P.length;j++){const d=Math.hypot(P[i].x-P[j].x,P[i].y-P[j].y);if(d<110){cx.beginPath();cx.moveTo(P[i].x,P[i].y);cx.lineTo(P[j].x,P[j].y);cx.strokeStyle=P[i].c;cx.globalAlpha=(1-d/110)*.05;cx.lineWidth=.5;cx.stroke();}}requestAnimationFrame(d);})();
})();
</script>
</body>
</html>
