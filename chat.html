<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nevro AI â€” Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;900&family=Syne:wght@700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<!-- CodeMirror -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/one-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/htmlmixed/htmlmixed.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/xml/xml.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/css/css.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/python/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/sql/sql.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/shell/shell.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/php/php.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/display/autorefresh.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<!-- Highlight.js for inline text highlighting -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/typescript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/sql.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/bash.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/php.min.js"></script>
<style>
:root{
  --bg:#07091a;--bg2:#0c1124;
  --surface:rgba(255,255,255,0.04);--surface2:rgba(255,255,255,0.07);
  --border:rgba(255,255,255,0.07);--bh:rgba(99,179,237,0.28);
  --cyan:#63b3ed;--cgl:rgba(99,179,237,0.13);
  --purple:#9f7aea;--pgl:rgba(159,122,234,0.13);
  --pink:#f687b3;--err:#fc8181;--ok:#68d391;
  --text:#eef2ff;--text2:rgba(238,242,255,0.56);--text3:rgba(238,242,255,0.30);
  --sw:268px;
}
[data-theme="light"]{
  --bg:#f0f4fc;--bg2:#e8edf8;
  --surface:rgba(0,0,0,0.03);--surface2:rgba(0,0,0,0.06);
  --border:rgba(0,0,0,0.07);--bh:rgba(37,99,235,0.22);
  --cyan:#2563eb;--cgl:rgba(37,99,235,0.09);
  --purple:#6d28d9;
  --text:#0f172a;--text2:rgba(15,23,42,0.60);--text3:rgba(15,23,42,0.35);
}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;}
html,body{height:100%;overflow:hidden;}
body{font-family:'Tajawal',sans-serif;background:var(--bg);color:var(--text);display:flex;transition:background .3s,color .3s;}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}

/* PAGE LOADER */
#pgLoad{position:fixed;inset:0;background:var(--bg);z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;}
.sp{width:32px;height:32px;border-radius:50%;border:3px solid var(--border);border-top-color:var(--cyan);animation:spin .8s linear infinite;}
#pgLoad p{font-size:14px;color:var(--text2);}

/* â•â• SIDEBAR â•â• */
.sidebar{width:var(--sw);height:100vh;background:var(--bg2);border-left:1px solid var(--border);display:flex;flex-direction:column;position:fixed;right:0;top:0;z-index:200;transition:transform .3s;}
.sb-head{padding:15px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;}
.brand{display:flex;align-items:center;gap:8px;text-decoration:none;flex:1;min-width:0;}
.brand-logo{width:28px;height:28px;border-radius:7px;overflow:hidden;flex-shrink:0;}
.brand-logo img{width:100%;height:100%;object-fit:cover;}
.brand-name{font-family:'Syne',sans-serif;font-size:14px;font-weight:800;background:linear-gradient(100deg,var(--cyan) 30%,var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent;white-space:nowrap;}
.sb-body{flex:1;padding:10px 8px;display:flex;flex-direction:column;gap:1px;overflow-y:auto;}
.sb-body::-webkit-scrollbar{width:3px;}
.sb-body::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}

.new-btn{width:100%;margin-bottom:8px;padding:10px;border-radius:11px;background:linear-gradient(135deg,var(--cyan),var(--purple));border:none;color:#fff;font-size:13px;font-weight:700;font-family:'Tajawal',sans-serif;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:7px;box-shadow:0 3px 12px var(--cgl);transition:all .25s;}
.new-btn:hover{transform:translateY(-1px);box-shadow:0 6px 18px var(--cgl);}
.new-btn:disabled{opacity:.5;cursor:not-allowed;transform:none;}
.new-btn svg{width:13px;height:13px;}

.sb-lbl{font-size:9px;text-transform:uppercase;letter-spacing:1.5px;color:var(--text3);padding:8px 8px 3px;font-weight:700;}
.sb-link{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:9px;font-size:13px;color:var(--text2);cursor:pointer;transition:all .2s;text-decoration:none;border:none;background:none;font-family:'Tajawal',sans-serif;width:100%;text-align:right;}
.sb-link:hover{background:var(--surface);color:var(--text);}
.sb-link svg{width:14px;height:14px;flex-shrink:0;}

.hist-item{display:flex;align-items:center;gap:8px;padding:7px 10px;border-radius:9px;font-size:13px;color:var(--text2);cursor:pointer;transition:all .2s;}
.hist-item:hover{background:var(--surface);color:var(--text);}
.hist-item.active{background:var(--cgl);color:var(--cyan);}
.hist-item svg{width:13px;height:13px;flex-shrink:0;opacity:.4;}
.hist-title{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.hist-del{opacity:0;flex-shrink:0;background:none;border:none;cursor:pointer;color:var(--err);padding:2px;border-radius:4px;display:flex;align-items:center;transition:opacity .2s;}
.hist-item:hover .hist-del{opacity:.55;}
.hist-del:hover{opacity:1!important;}
.hist-del svg{width:11px;height:11px;}

/* limits */
.sb-limits{margin:6px 8px;padding:10px 12px;border-radius:11px;background:var(--surface2);border:1px solid var(--border);}
.sb-lim-row{display:flex;justify-content:space-between;align-items:center;font-size:12px;margin-bottom:4px;}
.sb-lim-row:last-child{margin-bottom:0;}
.sb-lim-label{color:var(--text2);}
.sb-lim-val{font-weight:700;color:var(--cyan);}
.sb-lim-val.warn{color:var(--err);}

.sb-user{padding:10px 12px;border-top:1px solid var(--border);display:flex;align-items:center;gap:9px;cursor:pointer;transition:background .2s;}
.sb-user:hover{background:var(--surface);}
.user-av{width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,var(--cyan),var(--purple));display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:#fff;flex-shrink:0;}
.sb-uname{font-size:12px;font-weight:700;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}

/* â•â• MAIN â•â• */
.main{margin-right:var(--sw);flex:1;height:100vh;display:flex;flex-direction:column;overflow:hidden;}
.topbar{height:50px;flex-shrink:0;display:flex;align-items:center;justify-content:space-between;padding:0 18px;border-bottom:1px solid var(--border);background:var(--bg2);}
.topbar-l{display:flex;align-items:center;gap:10px;}
.mob-menu{display:none;width:30px;height:30px;border-radius:8px;border:1px solid var(--border);background:var(--surface);color:var(--text2);cursor:pointer;align-items:center;justify-content:center;flex-shrink:0;}
.mob-menu svg{width:14px;height:14px;}
#chatTitle{font-size:13px;font-weight:700;color:var(--text2);max-width:280px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.topbar-r{display:flex;align-items:center;gap:7px;}
.ic-btn{width:30px;height:30px;border-radius:8px;border:1px solid var(--border);background:var(--surface);color:var(--text2);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;}
.ic-btn:hover{border-color:var(--bh);color:var(--cyan);}
.ic-btn svg{width:14px;height:14px;}

/* â•â• MESSAGES â•â• */
.msgs-wrap{flex:1;overflow-y:auto;padding:24px 0;}
.msgs-wrap::-webkit-scrollbar{width:4px;}
.msgs-wrap::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}
.msgs-inner{max-width:760px;margin:0 auto;padding:0 24px;display:flex;flex-direction:column;gap:22px;}

/* â”€â”€ WELCOME SCREEN â”€â”€ */
.welcome{display:flex;flex-direction:column;align-items:center;min-height:70vh;padding-top:10vh;text-align:center;animation:fadeIn .4s;}
.w-logo{width:56px;height:56px;border-radius:15px;overflow:hidden;box-shadow:0 0 28px var(--cgl);margin-bottom:14px;}
.w-logo img{width:100%;height:100%;object-fit:cover;}
.w-title{font-family:'Syne',sans-serif;font-size:24px;font-weight:800;margin-bottom:6px;}
.w-sub{font-size:14px;color:var(--text2);max-width:380px;line-height:1.7;margin-bottom:28px;}

/* prompt cards grid */
.prompts-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;width:100%;max-width:580px;margin-bottom:12px;}
.prompt-card{text-align:right;padding:12px 14px;border-radius:13px;border:1px solid var(--border);background:var(--surface);transition:all .2s;animation:fadeUp .3s;position:relative;}
.prompt-card:hover{border-color:var(--bh);background:var(--cgl);}
.pc-top{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:8px;}
.pc-icon-wrap{display:flex;align-items:center;color:var(--cyan);opacity:.8;}
.pc-icon-wrap svg{width:18px;height:18px;}
.pc-fill-btn{width:26px;height:26px;border-radius:7px;border:1px solid var(--border);background:var(--surface2);color:var(--text3);cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .2s;}
.pc-fill-btn:hover{border-color:var(--bh);color:var(--cyan);background:var(--cgl);}
.pc-fill-btn svg{width:11px;height:11px;}
.prompt-card .pc-title{font-size:13px;font-weight:700;margin-bottom:3px;}
.prompt-card .pc-sub{font-size:11px;color:var(--text3);line-height:1.5;}

/* â”€â”€ MESSAGES â”€â”€ */
.msg{display:flex;gap:10px;animation:fadeUp .3s;}
.msg.user{flex-direction:row-reverse;}
.msg-av{width:30px;height:30px;border-radius:50%;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;margin-top:3px;}
.ai-av{background:var(--bg2);border:1px solid var(--border);overflow:hidden;color:#fff;}
.u-av{background:var(--surface2);border:1px solid var(--border);color:var(--text2);}
.msg-bubble{max-width:82%;padding:11px 15px;border-radius:16px;font-size:14px;line-height:1.85;}
.msg.ai .msg-bubble{background:var(--surface2);border:1px solid var(--border);border-top-right-radius:4px;}
.msg.user .msg-bubble{background:linear-gradient(135deg,rgba(99,179,237,0.15),rgba(159,122,234,0.15));border:1px solid var(--bh);border-top-left-radius:4px;}
.msg-bubble p{margin-bottom:8px;}
.msg-bubble p:last-child{margin-bottom:0;}
.msg-bubble pre{background:rgba(0,0,0,.3);border-radius:8px;padding:12px;margin:10px 0;overflow-x:auto;font-family:'JetBrains Mono',monospace;font-size:12px;line-height:1.6;border:1px solid var(--border);}
.msg-bubble code{font-family:'JetBrains Mono',monospace;font-size:12px;background:rgba(187,154,247,.12);color:#bb9af7;padding:2px 7px;border-radius:5px;border:1px solid rgba(187,154,247,.2);}
[data-theme="light"] .msg-bubble pre{background:rgba(0,0,0,.05);}
/* â”€â”€ Markdown: headings â”€â”€ */
.msg-bubble h1{font-size:18px;font-weight:800;margin:14px 0 6px;color:var(--text);}
.msg-bubble h2{font-size:16px;font-weight:700;margin:12px 0 5px;color:var(--text);}
.msg-bubble h3{font-size:14px;font-weight:700;margin:10px 0 4px;color:var(--cyan);}
/* â”€â”€ Markdown: lists â”€â”€ */
.msg-bubble ul,.msg-bubble ol{padding-right:20px;margin:6px 0 10px;}
.msg-bubble li{margin-bottom:4px;line-height:1.7;}
.msg-bubble ul li{list-style:disc;}
.msg-bubble ol li{list-style:decimal;}
/* â”€â”€ Markdown: blockquote â”€â”€ */
.msg-bubble blockquote{border-right:3px solid var(--cyan);padding:6px 12px;margin:8px 0;background:var(--cgl);border-radius:0 8px 8px 0;color:var(--text2);font-style:italic;}
/* â”€â”€ Markdown: hr â”€â”€ */
.msg-bubble hr{border:none;border-top:1px solid var(--border);margin:12px 0;}
/* â”€â”€ Comparison Table â”€â”€ */
.md-table-wrap{overflow-x:auto;margin:10px 0;border-radius:12px;border:1px solid var(--border);}
.md-table{width:100%;border-collapse:collapse;font-size:13px;}
.md-table th{background:linear-gradient(135deg,rgba(99,179,237,.12),rgba(159,122,234,.12));color:var(--cyan);font-weight:700;padding:9px 14px;text-align:right;border-bottom:1px solid var(--border);white-space:nowrap;}
.md-table td{padding:8px 14px;border-bottom:1px solid rgba(255,255,255,.04);color:var(--text2);vertical-align:top;}
.md-table tr:last-child td{border-bottom:none;}
.md-table tr:hover td{background:rgba(255,255,255,.02);}
[data-theme="light"] .md-table th{background:rgba(37,99,235,.07);}
[data-theme="light"] .md-table tr:hover td{background:rgba(0,0,0,.02);}
/* â”€â”€ Chart container â”€â”€ */
.chart-wrap{margin:14px 0;padding:18px 18px 14px;background:var(--bg2);border:1px solid var(--border);border-radius:16px;position:relative;overflow:hidden;}
.chart-wrap::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,var(--cgl),var(--pgl));pointer-events:none;}
.chart-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;position:relative;}
.chart-title{font-size:13px;font-weight:700;color:var(--text);display:flex;align-items:center;gap:7px;}
.chart-title::before{content:'';width:8px;height:8px;border-radius:50%;background:linear-gradient(135deg,var(--cyan),var(--purple));}
.chart-type-btns{display:flex;gap:4px;}
.chart-type-btn{padding:3px 8px;border-radius:6px;border:1px solid var(--border);background:transparent;color:var(--text3);font-size:10px;font-weight:700;cursor:pointer;font-family:Tajawal,sans-serif;transition:all .2s;}
.chart-type-btn.active,.chart-type-btn:hover{border-color:var(--bh);color:var(--cyan);background:var(--cgl);}
.chart-canvas-wrap{position:relative;height:260px;}
.typing-dots{display:flex;gap:4px;padding:8px 2px;}
.typing-dots span{width:6px;height:6px;border-radius:50%;background:var(--cyan);animation:blink 1.2s ease infinite;}
.typing-dots span:nth-child(2){animation-delay:.2s;}
.typing-dots span:nth-child(3){animation-delay:.4s;}

/* â•â• INPUT â•â• */
.input-area{padding:12px 18px 16px;border-top:1px solid var(--border);flex-shrink:0;background:var(--bg2);}
.input-inner{max-width:760px;margin:0 auto;}
.input-row{display:flex;gap:8px;align-items:flex-end;}
/* input-box handled above */
.input-box-x{display:flex;align-items:flex-end;gap:10px;background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:10px 12px;transition:border-color .25s,box-shadow .25s;}
.input-box:focus-within{border-color:var(--bh);box-shadow:0 0 0 3px var(--cgl);}
#msgIn{flex:1;background:none;border:none;outline:none;color:var(--text);font-family:'Tajawal',sans-serif;font-size:14px;resize:none;max-height:160px;min-height:24px;line-height:1.6;direction:rtl;}
#msgIn::placeholder{color:var(--text3);}
.send-btn{width:34px;height:34px;border-radius:10px;flex-shrink:0;background:linear-gradient(135deg,var(--cyan),var(--purple));border:none;color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 10px var(--cgl);transition:all .25s;}
.send-btn:hover:not(:disabled){transform:translateY(-1px);box-shadow:0 5px 16px var(--cgl);}
.send-btn:disabled{opacity:.45;cursor:not-allowed;transform:none;}
.send-btn svg,.sp-s{transition:opacity .2s;}
.sp-s{width:14px;height:14px;border-radius:50%;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;animation:spin .7s linear infinite;display:none;}
.input-foot{display:flex;justify-content:space-between;align-items:center;margin-top:7px;padding:0 2px;}
.input-hint{font-size:11px;color:var(--text3);}
#limBadge{font-size:11px;font-weight:700;color:var(--text3);}
#limBadge.warn{color:var(--err);}

/* â•â• UPGRADE POPUP â•â• */
.pop-ov{position:fixed;inset:0;background:rgba(0,0,0,.65);z-index:500;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(8px);opacity:0;pointer-events:none;transition:opacity .3s;}
.pop-ov.show{opacity:1;pointer-events:all;}
.pop-box{background:var(--bg2);border:1px solid var(--bh);border-radius:24px;padding:36px 30px;max-width:400px;width:92%;text-align:center;box-shadow:0 28px 64px rgba(0,0,0,.55);transform:translateY(20px) scale(.97);transition:transform .35s;position:relative;}
.pop-ov.show .pop-box{transform:translateY(0) scale(1);}
.pop-x{position:absolute;top:14px;left:14px;width:28px;height:28px;border-radius:50%;border:1px solid var(--border);background:var(--surface);color:var(--text2);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;}
.pop-x:hover{border-color:var(--bh);color:var(--text);}
.pop-x svg{width:12px;height:12px;}
.pop-icon{width:60px;height:60px;border-radius:50%;background:linear-gradient(135deg,var(--cyan),var(--purple));display:flex;align-items:center;justify-content:center;margin:0 auto 16px;box-shadow:0 0 28px var(--cgl);}
.pop-icon svg{width:26px;height:26px;color:#fff;}
.pop-title{font-family:'Syne',sans-serif;font-size:20px;font-weight:800;margin-bottom:8px;}
.pop-sub{font-size:14px;color:var(--text2);line-height:1.7;margin-bottom:20px;}
.pop-sub strong{color:var(--cyan);}
.pop-feats{display:flex;flex-direction:column;gap:8px;margin-bottom:22px;text-align:right;}
.pop-feat{display:flex;align-items:center;gap:9px;font-size:13px;color:var(--text2);}
.pop-feat svg{width:14px;height:14px;color:var(--ok);flex-shrink:0;}
.pop-cta{width:100%;padding:13px;border-radius:12px;background:linear-gradient(135deg,var(--cyan),var(--purple));border:none;color:#fff;font-size:15px;font-weight:700;font-family:'Tajawal',sans-serif;cursor:pointer;box-shadow:0 6px 20px var(--cgl);transition:all .25s;margin-bottom:10px;}
.pop-cta:hover{transform:translateY(-2px);box-shadow:0 10px 28px var(--cgl);}
.pop-skip{font-size:12px;color:var(--text3);cursor:pointer;background:none;border:none;font-family:'Tajawal',sans-serif;transition:color .2s;}
.pop-skip:hover{color:var(--text2);}

.sb-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:190;backdrop-filter:blur(3px);}

/* â•â• TABLET â•â• */
@media(max-width:1024px) and (min-width:801px){
  :root{--sw:220px;}
  .msgs-inner{max-width:620px;}
  .input-inner{max-width:620px;}
  .msg-bubble{max-width:88%;}
  .w-title{font-size:20px;}
  .prompts-grid{max-width:480px;}
}

/* â•â• MOBILE â•â• */
@media(max-width:800px){
  .sidebar{transform:translateX(100%);}
  .sidebar.open{transform:translateX(0);}
  .sb-overlay.open{display:block;}
  .main{margin-right:0;}
  .mob-menu{display:flex;}
  /* messages */
  .msgs-inner{padding:0 12px;gap:14px;}
  .msg-bubble{max-width:90%;font-size:13.5px;padding:10px 13px;}
  .msg-av{width:26px;height:26px;}
  /* input */
  .input-area{padding:8px 10px 12px;}
  /* welcome */
  .w-title{font-size:19px;}
  .w-sub{font-size:13px;margin-bottom:18px;}
  .prompts-grid{grid-template-columns:1fr;max-width:100%;}
  /* topbar */
  .topbar{padding:0 12px;}
  #chatTitle{max-width:180px;font-size:12px;}
  /* code blocks */
  .hljs-code{font-size:11.5px!important;}
  .code-header{padding:6px 10px;}
  .code-act-btn{padding:3px 8px;font-size:10px;}
}

/* â•â• SMALL MOBILE â•â• */
@media(max-width:380px){
  .msg-bubble{max-width:95%;font-size:13px;}
  .ic-btn{width:26px;height:26px;}
  #chatTitle{max-width:120px;}
}

/* â•â• MODEL BADGE (desktop only) â•â• */
.model-badge{display:flex;align-items:center;gap:5px;padding:4px 10px;border-radius:999px;border:1px solid var(--border);background:var(--surface);font-size:11px;font-weight:700;color:var(--text3);}
.model-badge-dot{width:6px;height:6px;border-radius:50%;background:#68d391;animation:pulse 2s ease infinite;}
@keyframes pulse{0%,100%{opacity:1;box-shadow:0 0 0 0 rgba(104,211,145,.4)}50%{opacity:.8;box-shadow:0 0 0 4px rgba(104,211,145,0)}}
@media(max-width:800px){.model-badge{display:none;}}

/* â•â• CODE BLOCK â•â• */
.code-block{border-radius:13px;overflow:hidden;border:1px solid rgba(255,255,255,.08);margin:10px 0;background:#1a1b26;}
.code-header{display:flex;align-items:center;justify-content:space-between;padding:8px 14px;background:#13141f;border-bottom:1px solid rgba(255,255,255,.06);}
.code-lang-badge{display:flex;align-items:center;gap:6px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;}
.code-lang-dot{width:7px;height:7px;border-radius:50%;}
.code-actions{display:flex;align-items:center;gap:6px;}
.code-act-btn{display:flex;align-items:center;gap:5px;padding:4px 10px;border-radius:7px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);color:rgba(238,242,255,.55);font-size:11px;font-weight:600;font-family:'Tajawal',sans-serif;cursor:pointer;transition:all .2s;white-space:nowrap;}
.code-act-btn:hover{border-color:rgba(99,179,237,.4);color:#63b3ed;background:rgba(99,179,237,.08);}
.code-act-btn.copied{border-color:rgba(104,211,145,.4)!important;color:#68d391!important;background:rgba(104,211,145,.08)!important;}
.code-act-btn svg{width:12px;height:12px;flex-shrink:0;}
/* CodeMirror overrides */
/* â•â• HIGHLIGHT.JS CODE BLOCK â•â• */
.cm-wrap{overflow:auto;max-height:460px;border-radius:0 0 12px 12px;}
.cm-wrap::-webkit-scrollbar{width:5px;height:5px;}
.cm-wrap::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1);border-radius:3px;}
.hljs-block{display:flex;direction:ltr;text-align:left;min-width:0;}
.hljs-gutter{flex-shrink:0;padding:16px 12px;background:#13141f;color:rgba(169,177,214,.2);font-family:'JetBrains Mono',monospace;font-size:12.5px;line-height:1.75;user-select:none;text-align:right;border-right:1px solid rgba(255,255,255,.05);min-width:38px;}
.hljs-gutter .hljs-ln{display:block;}
.hljs-code{flex:1;margin:0;padding:16px;background:#1a1b26;font-family:'JetBrains Mono',monospace;font-size:13px;line-height:1.75;overflow-x:auto;white-space:pre;}
.hljs-code code{font-family:inherit;font-size:inherit;background:none;padding:0;border-radius:0;white-space:pre;}
/* Override hljs atom-one-dark background to match our theme */
.hljs{background:#1a1b26!important;color:#a9b1d6;}
/* Token colors â€” rich and distinct like VS Code */
.hljs-keyword,.hljs-selector-tag,.hljs-type{color:#bb9af7;font-weight:600;}
.hljs-built_in,.hljs-builtin-name{color:#7dcfff;}
.hljs-string,.hljs-attr,.hljs-template-variable{color:#9ece6a;}
.hljs-comment,.hljs-quote{color:#565f89;font-style:italic;}
.hljs-number,.hljs-literal{color:#ff9e64;}
.hljs-function,.hljs-name{color:#7aa2f7;}
.hljs-class .hljs-title,.hljs-title{color:#e0af68;}
.hljs-variable,.hljs-template-tag{color:#f7768e;}
.hljs-regexp,.hljs-link{color:#73daca;}
.hljs-tag{color:#f7768e;}
.hljs-attribute{color:#bb9af7;}
.hljs-operator,.hljs-punctuation{color:#89ddff;}
.hljs-meta{color:#ff9e64;}
.hljs-params{color:#cfc9c2;}
/* Light theme */
[data-theme="light"] .hljs{background:#f8f9fc!important;color:#24292f;}
[data-theme="light"] .hljs-gutter{background:#f0f2f7;color:#8b949e;border-right-color:rgba(0,0,0,.06);}
[data-theme="light"] .hljs-code{background:#f8f9fc;}
[data-theme="light"] .hljs-keyword{color:#8250df;}
[data-theme="light"] .hljs-string{color:#0a7250;}
[data-theme="light"] .hljs-comment{color:#6e7781;}
[data-theme="light"] .hljs-number{color:#953800;}
[data-theme="light"] .hljs-function,[data-theme="light"] .hljs-name{color:#0550ae;}
[data-theme="light"] .hljs-variable{color:#cf222e;}
/* Preview */


/* â•â• MODEL DROPDOWN â•â• */
.input-box{position:relative;flex:1;display:flex;flex-direction:column;}
.input-box textarea{width:100%;min-height:52px;max-height:200px;padding:14px 16px 40px;background:var(--surface);border:1px solid var(--border);border-radius:16px;color:var(--text);font-family:inherit;font-size:15px;resize:none;outline:none;transition:border .2s;line-height:1.5;}
.input-box textarea:focus{border-color:var(--bh);}
.input-actions{position:absolute;bottom:8px;right:10px;display:flex;align-items:center;gap:6px;}
.model-drop-wrap{position:relative;}
.model-drop-btn{display:flex;align-items:center;gap:5px;padding:4px 9px;border-radius:20px;border:1px solid var(--border);background:var(--bg2);color:var(--text2);font-size:11px;font-weight:600;cursor:pointer;font-family:inherit;transition:all .2s;}
.model-drop-btn:hover{border-color:var(--bh);color:var(--text);}
.model-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0;}
.drop-arrow{width:10px;height:10px;transition:transform .2s;opacity:.5;}
.model-drop-btn.open .drop-arrow{transform:rotate(180deg);}
.model-drop{position:absolute;bottom:calc(100% + 8px);left:0;min-width:220px;background:var(--bg2);border:1px solid var(--border);border-radius:14px;padding:6px;box-shadow:0 16px 40px rgba(0,0,0,.5);z-index:200;display:none;}
.model-drop.open{display:block;animation:fadeUp .15s ease;}
.model-opt{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;cursor:pointer;transition:background .15s;}
.model-opt:hover{background:var(--cgl);}
.model-opt.active{background:rgba(99,179,237,.08);}
.model-opt-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.model-opt-info{flex:1;}
.model-opt-name{font-size:13px;font-weight:700;color:var(--text);display:flex;align-items:center;gap:6px;}
.model-opt-desc{font-size:11px;color:var(--text3);margin-top:2px;}
.model-opt-check{width:14px;height:14px;color:var(--cyan);flex-shrink:0;}
.pro-count{background:rgba(246,173,85,.2);color:#f6ad55;border-radius:8px;padding:1px 6px;font-size:10px;font-weight:700;}
.pro-count.empty{color:var(--text3);background:rgba(255,255,255,.05);}

/* â•â• ACTIVE MODEL BADGE (topbar) â•â• */
.active-model-badge{display:flex;align-items:center;gap:5px;padding:4px 10px;border-radius:20px;background:var(--surface);border:1px solid var(--border);font-size:11px;font-weight:700;color:var(--text);}
.active-model-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;animation:pulse 2s infinite;}
</style>
</head>
<body>

<div id="pgLoad"><div class="sp"></div><p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p></div>
<div class="sb-overlay" id="sbOv" onclick="closeSb()"></div>

<!-- â•â• UPGRADE POPUP â•â• -->
<div class="pop-ov" id="popup">
  <div class="pop-box">
    <button class="pop-x" onclick="closePopup()"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg></button>
    <div class="pop-icon"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/></svg></div>
    <div class="pop-title" id="popTitle">ÙˆØµÙ„Øª Ù„Ù„Ø­Ø¯!</div>
    <div class="pop-sub" id="popSub"></div>
    <div class="pop-feats">
      <div class="pop-feat"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>Ù…Ø­Ø§Ø¯Ø«Ø§Øª ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯Ø© ÙŠÙˆÙ…ÙŠØ§Ù‹</div>
      <div class="pop-feat"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>150+ Ù…Ø­Ø§Ø¯Ø«Ø© ÙÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨</div>
      <div class="pop-feat"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª ÙˆØ§Ù„ØµÙˆØ±</div>
      <div class="pop-feat"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>Ø£ÙˆØ¶Ø§Ø¹ Ù…ØªÙ‚Ø¯Ù…Ø© Ø¨Ù„Ø§ Ù‚ÙŠÙˆØ¯</div>
    </div>
    <button class="pop-cta" onclick="location.href='pricing.html'">Ø§Ù„ØªØ±Ù‚ÙŠØ© Ø¥Ù„Ù‰ Pro</button>
    <button class="pop-skip" onclick="closePopup()">Ø±Ø¨Ù…Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹</button>
  </div>
</div>

<!-- â•â• SIDEBAR â•â• -->
<aside class="sidebar" id="sb">
  <div class="sb-head">
    <a class="brand" href="dashboard.html">
      <div class="brand-logo"><img src="img/logo.png" alt="" onerror="this.parentElement.style.background='linear-gradient(135deg,#63b3ed,#9f7aea)'"></div>
      <span class="brand-name">Nevro AI</span>
    </a>
  </div>
  <div class="sb-body">
    <button class="new-btn" id="newBtn" onclick="newChat()">
      <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
      Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©
    </button>
    <div class="sb-lbl">Ø§Ù„ØªÙ†Ù‚Ù„</div>
    <a class="sb-link" href="dashboard.html">
      <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
      Ø§Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
    </a>
    <div class="sb-lbl">Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª</div>
    <div id="histList"><div style="padding:8px 10px;font-size:12px;color:var(--text3)">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div></div>
  </div>
  <div class="sb-limits">
    <div class="sb-lim-row"><span class="sb-lim-label">Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„ÙŠÙˆÙ…</span><span class="sb-lim-val" id="sbDaily">â€” / 10</span></div>
    <div class="sb-lim-row"><span class="sb-lim-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª</span><span class="sb-lim-val" id="sbTotal">â€” / 150</span></div>
  </div>
  <div class="sb-user" onclick="location.href='settings.html'">
    <div class="user-av" id="uAv">ØŸ</div>
    <span class="sb-uname" id="uName">...</span>
  </div>
</aside>

<!-- â•â• MAIN â•â• -->
<div class="main">
  <div class="topbar">
    <div class="topbar-l">
      <button class="mob-menu" onclick="openSb()"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"/></svg></button>
      <div id="chatTitle">Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©</div>
    </div>
    <div class="topbar-r">
      <div class="active-model-badge" id="activeModelBadge">
        <span class="active-model-dot" id="activeModelDot" style="background:#63b3ed"></span>
      </div>
      <button class="ic-btn" id="themeBtn" onclick="toggleTheme()">
        <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 12.79A9 9 0 1111.21 3a7 7 0 009.79 9.79z"/></svg>
      </button>
      <button class="ic-btn" onclick="newChat()">
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
      </button>
    </div>
  </div>

  <div class="msgs-wrap" id="msgsWrap">
    <div class="msgs-inner" id="msgsInner"></div>
  </div>

  <div class="input-area">
    <div class="input-inner">
      <div class="input-row">
        <div class="input-box">
          <textarea id="msgIn" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..." rows="1" onkeydown="onKey(event)" oninput="resize(this)"></textarea>
          <div class="input-actions">
            <div class="model-drop-wrap" id="modelDropWrap">
              <button class="model-drop-btn" id="modelDropBtn" onclick="toggleModelDrop()">
                <span class="model-dot" id="modelDot" style="background:#63b3ed"></span>
                <svg class="drop-arrow" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/></svg>
              </button>
              <div class="model-drop" id="modelDrop">
                <div class="model-opt active" id="optV1" onclick="selectTier('v1')">
                  <span class="model-opt-dot" style="background:#63b3ed"></span>
                  <div class="model-opt-info">
                    <div class="model-opt-name">Ø¹Ø§Ø¯ÙŠ</div>
                    <div class="model-opt-desc">Ø³Ø±ÙŠØ¹ ÙˆÙ…Ø¬Ø§Ù†ÙŠ</div>
                  </div>
                  <svg class="model-opt-check" id="checkV1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>
                </div>
                <div class="model-opt" id="optPro" onclick="selectTier('pro')">
                  <span class="model-opt-dot" style="background:#f6ad55"></span>
                  <div class="model-opt-info">
                    <div class="model-opt-name">Pro <span class="pro-count" id="proCount">3</span></div>
                    <div class="model-opt-desc">Ø§Ù„Ø£Ù‚ÙˆÙ‰ ÙˆØ§Ù„Ø£Ø°ÙƒÙ‰</div>
                  </div>
                  <svg class="model-opt-check" id="checkPro" style="display:none" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>
                </div>
              </div>
            </div>
          </div>
        </div>
        <button class="send-btn" id="sendBtn" onclick="send()">
          <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
          <div class="sp-s" id="sendSp"></div>
        </button>
      </div>
      <div class="input-foot">
        <span class="input-hint">Enter Ù„Ù„Ø¥Ø±Ø³Ø§Ù„ Â· Shift+Enter Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯</span>
        <span id="limBadge">10 Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ù…ØªØ¨Ù‚ÙŠØ© Ø§Ù„ÙŠÙˆÙ…</span>
      </div>
    </div>
  </div>
</div>

<script>
/* â•â• HELPERS â•â• */
function X(s)  { return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"); }
function XH(s) { return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }

/* â•â• SUPABASE â•â• */
const SURL = "https://nhykoxjgtilnqgnmehkm.supabase.co";
const SKEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5oeWtveGpndGlsbnFnbm1laGttIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE3MDIwMDMsImV4cCI6MjA4NzI3ODAwM30.DCV36AHiWKYIeB62ZjG-zdz_k7FtyaYVkyQXpE3SP-s";
// Edge Function URL â€” Ø¨Ø¹Ø¯ Ù…Ø§ ØªØ¹Ù…Ù„ deploy
const EDGE_URL = SURL + "/functions/v1/chat";

const sb = supabase.createClient(SURL, SKEY);

/* â•â• PROMPTS DATA â•â•
   fill: true  â†’ ÙŠÙ†Ù‚Ù„ Ø§Ù„Ù†Øµ Ù„Ù„Ø­Ù‚Ù„ ÙÙ‚Ø· (Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠÙƒÙ…Ù„)
   fill: false â†’ ÙŠØ±Ø³Ù„ Ù…Ø¨Ø§Ø´Ø±Ø©
â•â• */
const PROMPTS = [
  {
    icon: `<svg width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>`,
    title: "Ø³Ø§Ø¹Ø¯Ù†ÙŠ ÙÙŠ Ø§Ù„ÙƒØªØ§Ø¨Ø©",
    sub: "Ø¥ÙŠÙ…ÙŠÙ„ØŒ Ù…Ù‚Ø§Ù„ØŒ Ø£Ùˆ ØªÙ‚Ø±ÙŠØ± Ø§Ø­ØªØ±Ø§ÙÙŠ",
    fill: true,
    text: "Ø³Ø§Ø¹Ø¯Ù†ÙŠ Ø£ÙƒØªØ¨ "
  },
  {
    icon: `<svg width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>`,
    title: "ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª",
    sub: "Ø§Ø³ØªØ®Ø±Ø¬ Ø±Ø¤Ù‰ Ù…Ù† Ø£Ø±Ù‚Ø§Ù…Ùƒ",
    fill: true,
    text: "Ø­Ù„Ù‘Ù„ Ù„ÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: "
  },
  {
    icon: `<svg width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>`,
    title: "Ø§Ù‚ØªØ±Ø­ Ø£ÙÙƒØ§Ø±Ø§Ù‹",
    sub: "Ø£ÙÙƒØ§Ø± Ø¥Ø¨Ø¯Ø§Ø¹ÙŠØ© Ù„Ø£ÙŠ Ù…ÙˆØ¶ÙˆØ¹",
    fill: true,
    text: "Ø§Ù‚ØªØ±Ø­ Ù„ÙŠ Ø£ÙÙƒØ§Ø±Ø§Ù‹ Ø¹Ù† "
  },
  {
    icon: `<svg width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3"/></svg>`,
    title: "Ù‚Ø§Ø±Ù† Ø¨ÙŠÙ†",
    sub: "Ù…Ù‚Ø§Ø±Ù†Ø© Ø¯Ù‚ÙŠÙ‚Ø© Ø¨ÙŠÙ† Ø®ÙŠØ§Ø±ÙŠÙ† Ø£Ùˆ Ø£ÙƒØ«Ø±",
    fill: true,
    text: "Ù‚Ø§Ø±Ù† Ø¨ÙŠÙ† "
  },
];

// (categories removed â€” prompts are now flat)

/* â•â• STATE â•â• */
let user = null, chatId = null, msgs = [], loading = false, totalChats = 0, uInit = "ØŸ";
const DAILY = 10, TOTAL = 150;
const PRO_LIMIT    = 3;
const SEARCH_LIMIT = 3;
let proUsedToday    = 0;
let searchUsedToday = 0;

/* â•â• DAILY COUNTER (Supabase) â•â• */
let dailyUsed = 0;

async function loadDaily() {
  const today = new Date().toISOString().slice(0, 10);
  const { data } = await sb.from("usage")
    .select("chat_count")
    .eq("user_id", user.id)
    .eq("date", today)
    .maybeSingle();
  dailyUsed = data ? (data.chat_count || 0) : 0;
}

function getDaily() { return dailyUsed; }

async function incDaily() {
  const today = new Date().toISOString().slice(0, 10);
  dailyUsed++;
  await sb.from("usage").upsert(
    { user_id: user.id, date: today, chat_count: dailyUsed },
    { onConflict: "user_id,date" }
  );
}

/* â•â• LIMIT UI â•â• */
function refreshLimits() {
  const used = getDaily(), left = DAILY - used;
  const totLeft = TOTAL - totalChats;

  const sd = document.getElementById("sbDaily");
  sd.textContent = used + " / " + DAILY;
  sd.className = "sb-lim-val" + (left <= 2 ? " warn" : "");

  const st = document.getElementById("sbTotal");
  st.textContent = totalChats + " / " + TOTAL;
  st.className = "sb-lim-val" + (totLeft <= 10 ? " warn" : "");

  const lb = document.getElementById("limBadge");
  lb.textContent = left + " Ù…Ø­Ø§Ø¯Ø«Ø© Ù…ØªØ¨Ù‚ÙŠØ© Ø§Ù„ÙŠÙˆÙ…";
  lb.className = left <= 3 ? "warn" : "";

  document.getElementById("newBtn").disabled = (left <= 0 || totLeft <= 0);
}

function canSearch() {
  if (searchUsedToday >= SEARCH_LIMIT) {
    showPopup("search");
    return false;
  }
  return true;
}

function checkLimits() {
  if (chatId) return true; // continuing = always ok
  if (getDaily() >= DAILY) { showPopup("daily"); return false; }
  if (totalChats >= TOTAL) { showPopup("total"); return false; }
  return true;
}

/* â•â• INIT â•â• */
(async () => {
  const { data: { session } } = await sb.auth.getSession();
  if (!session) { location.href = "login.html"; return; }
  user = session.user;
  const m = user.user_metadata || {};
  const full = m.full_name || m.name || user.email.split("@")[0];
  uInit = full.slice(0, 2).toUpperCase();
  document.getElementById("uName").textContent = full;
  document.getElementById("uAv").textContent = uInit;
  await loadHist();
  await loadDaily();
  showWelcome();
  refreshLimits();
  const pid = new URLSearchParams(location.search).get("id");
  if (pid) await loadChat(pid);
  document.getElementById("pgLoad").style.display = "none";
  document.getElementById("msgIn").focus();
})();

/* â•â• LOAD HISTORY â•â• */
async function loadHist() {
  const { data } = await sb.from("conversations").select("id,title,created_at").eq("user_id", user.id).order("created_at", { ascending: false });
  totalChats = data ? data.length : 0;
  refreshLimits();
  const el = document.getElementById("histList");
  if (!data || !data.length) { el.innerHTML = `<div style="padding:8px 10px;font-size:12px;color:var(--text3)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø¨Ø¹Ø¯</div>`; return; }
  el.innerHTML = data.map(c => `
    <div class="hist-item${c.id === chatId ? " active" : ""}" id="hi-${X(c.id)}" onclick="loadChat('${X(c.id)}')">
      <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8"><path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
      <span class="hist-title">${X(c.title || "Ù…Ø­Ø§Ø¯Ø«Ø©")}</span>
      <button class="hist-del" onclick="event.stopPropagation();delChat('${X(c.id)}')" title="Ø­Ø°Ù">
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/><path d="M10 11v6m4-6v6"/><path d="M9 6V4h6v2"/></svg>
      </button>
    </div>`).join("");
}

/* â•â• LOAD CHAT â•â• */
async function loadChat(id) {
  chatId = id; msgs = [];
  document.querySelectorAll(".hist-item").forEach(e => e.classList.remove("active"));
  document.getElementById("hi-" + id)?.classList.add("active");
  const { data } = await sb.from("messages").select("role,content").eq("conversation_id", id).order("created_at", { ascending: true });
  clearMsgs(false);
  if (data?.length) { data.forEach(m => { msgs.push({ role: m.role, content: m.content }); addMsg(m.role, m.content); }); scrollBot(); }
  // init all code mirrors after loading history
  setTimeout(() => initCodeMirrors(document.getElementById("msgsInner")), 200);
  const t = document.getElementById("hi-" + id)?.querySelector(".hist-title")?.textContent || "Ù…Ø­Ø§Ø¯Ø«Ø©";
  document.getElementById("chatTitle").textContent = t;
  history.replaceState(null, "", "?id=" + id);
}

/* â•â• SEND â•â• */
async function send() {
  const inp = document.getElementById("msgIn");
  const text = inp.value.trim();
  if (!text || loading) return;
  if (!checkLimits()) return;
  inp.value = ""; resize(inp);
  clearWelcome(); addMsg("user", text); msgs.push({ role: "user", content: text });

  if (!chatId) {
    const title = text.slice(0, 60);
    const { data: c } = await sb.from("conversations").insert({ user_id: user.id, title }).select().single();
    if (c) {
      chatId = c.id; totalChats++; incDaily();
      history.replaceState(null, "", "?id=" + c.id);
      document.getElementById("chatTitle").textContent = title;
      await loadHist(); refreshLimits();
    }
  }
  if (chatId) await sb.from("messages").insert({ conversation_id: chatId, role: "user", content: text });

  setLoad(true);
  // Ù‡Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¯ÙŠ Ù…Ø­ØªØ§Ø¬Ø© Ø¨Ø­Ø«ØŸ
  const searchKeywords = [
    // Ø²Ù…Ù† Ø­Ø§Ù„ÙŠ Ø£Ùˆ Ù‚Ø±ÙŠØ¨
    "Ø§Ù„Ø¢Ù†","Ø­Ø§Ù„ÙŠØ§Ù‹","Ø­Ø§Ù„ÙŠØ§","Ø§Ù„ÙŠÙˆÙ…","Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹","Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±","Ù‡Ø°Ù‡ Ø§Ù„Ø³Ù†Ø©",
    "Ø£Ø­Ø¯Ø«","Ø¢Ø®Ø±","Ø¬Ø¯ÙŠØ¯","Ø­Ø¯ÙŠØ«","2025","2026","Ù…Ø¤Ø®Ø±Ø§Ù‹",
    "currently","latest","now","today","recent","2025","2026",
    // Ø¨Ø­Ø« ØµØ±ÙŠØ­
    "Ø§Ø¨Ø­Ø«","Ø¯ÙˆØ±","ÙÙŠÙ†","ÙˆÙŠÙ†","search","find",
    // Ø£Ø®Ø¨Ø§Ø± ÙˆØ£Ø­Ø¯Ø§Ø«
    "Ø£Ø®Ø¨Ø§Ø±","Ø®Ø¨Ø±","Ù†ØªÙŠØ¬Ø©","Ù…Ø¨Ø§Ø±Ø§Ø©","Ø¨Ø·ÙˆÙ„Ø©","Ø§Ù†ØªØ®Ø§Ø¨","news","result",
    // Ø£Ø³Ø¹Ø§Ø± ÙˆØ¨ÙŠØ§Ù†Ø§Øª Ù…ØªØºÙŠØ±Ø©
    "Ø³Ø¹Ø±","ÙƒÙ… Ø³Ø¹Ø±","price","stock",
    // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ù† Ø£Ø´Ø®Ø§Øµ/Ø´Ø±ÙƒØ§Øª
    "Ù…Ù† Ù‡Ùˆ","Ù…Ù† Ù‡ÙŠ","Ù…Ø§ Ù‡Ùˆ","Ù…Ø§ Ù‡ÙŠ","who is","what is",
  ];
  const willSearch = searchKeywords.some(k => text.toLowerCase().includes(k.toLowerCase()));
  const typEl = addTyping(willSearch);

  let ai = "";
  try {
    const { data: { session } } = await sb.auth.getSession();
    const res = await fetch(EDGE_URL, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "apikey": SKEY,
        "Authorization": "Bearer " + (session?.access_token || SKEY)
      },
      body: JSON.stringify({ messages: msgs, tier: selectedTier === "auto" ? "pro" : selectedTier })
    });
    const json = await res.json();
    if (res.ok) {
      ai = json.choices?.[0]?.message?.content || "";
      if (!ai) ai = json.error?.message ? "Ø®Ø·Ø£: " + json.error.message : "Ù„Ù… Ø£ØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„Ø±Ø¯ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ø§Ù‹.";
      // ØªØ­Ø¯ÙŠØ« counters
      if (json.pro_used    !== undefined) { proUsedToday    = json.pro_used;    updateProCount(json.pro_used, json.pro_limit || 3); }
      if (json.search_used !== undefined)   searchUsedToday = json.search_used;
      // ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„ ÙÙŠ Ø§Ù„Ù€ dropdown
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù€ dot Ø¨Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„ Ø§Ù„Ù„ÙŠ Ø±Ø¯ ÙØ¹Ù„Ø§Ù‹
      const usedDot = json.tier === "pro" ? "#f6ad55" : "#63b3ed";
      document.getElementById("modelDot").style.background = usedDot;
      if (document.getElementById("activeModelDot"))
        document.getElementById("activeModelDot").style.background = usedDot;
      // Search badge
      if (json.searched) ai = "ğŸŒ **Ø¨Ø­Ø« Ø¹Ø¨Ø± " + (json.search_source||"Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª") + "**\n\n" + ai;
      refreshLimits();
    } else {
      console.error("Edge error:", json);
      ai = "Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø¬Ø¯Ø¯Ø§Ù‹.";
    }
  } catch (e) {
    console.error("FETCH ERROR:", e);
    ai = "Ø®Ø·Ø£: " + (e?.message || String(e));
  }

  typEl.remove(); setLoad(false);
  msgs.push({ role: "assistant", content: ai }); addMsg("assistant", ai); scrollBot();
  if (chatId) {
    await sb.from("messages").insert({ conversation_id: chatId, role: "assistant", content: ai });
    await sb.from("conversations").update({ updated_at: new Date().toISOString() }).eq("id", chatId);
  }
}

/* â•â• NEW CHAT â•â• */
function newChat() {
  if (!checkLimits()) return;
  chatId = null; msgs = []; clearMsgs(true);
  document.getElementById("chatTitle").textContent = "Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©";
  document.querySelectorAll(".hist-item").forEach(e => e.classList.remove("active"));
  history.replaceState(null, "", location.pathname);
  document.getElementById("msgIn").focus();
}

/* â•â• DELETE â•â• */
async function delChat(id) {
  if (!confirm("Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) return;
  await sb.from("messages").delete().eq("conversation_id", id);
  await sb.from("conversations").delete().eq("id", id);
  if (chatId === id) { chatId = null; clearMsgs(true); document.getElementById("chatTitle").textContent = "Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©"; }
  await loadHist();
}

/* â•â• WELCOME SCREEN â•â• */
function showWelcome() {
  document.getElementById("msgsInner").innerHTML = `<div class="welcome" id="wEl">
    <div class="w-logo"><img src="img/logo.png" alt="" onerror="this.parentElement.style.background='linear-gradient(135deg,#63b3ed,#9f7aea)'"></div>
    <div class="w-title">ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒØŸ</div>
    <div class="w-sub">Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ø£Ù…Ø«Ù„Ø© Ø£Ùˆ Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù…Ø¨Ø§Ø´Ø±Ø©</div>
    <div class="prompts-grid" id="promptGrid"></div>
  </div>`;
  renderPrompts();
}

function renderPrompts() {
  const el = document.getElementById("promptGrid");
  if (!el) return;
  el.innerHTML = PROMPTS.map((p, i) => {
    const safeText = p.text.replace(/\\/g,"\\\\").replace(/`/g,"\\`").replace(/\$/g,"\\$");
    return `<div class="prompt-card" style="animation-delay:${i * 0.05}s">
      <div class="pc-top">
        <div class="pc-icon-wrap">${p.icon}</div>
        <button class="pc-fill-btn" onclick="fillInput(PROMPTS[${i}].text)" title="Ø£Ø¶Ù Ù„Ù„Ø­Ù‚Ù„">
          <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
        </button>
      </div>
      <div class="pc-title">${p.title}</div>
      <div class="pc-sub">${p.sub}</div>
    </div>`;
  }).join("");
}

function fillInput(text) {
  const inp = document.getElementById("msgIn");
  inp.value = text;
  resize(inp);
  inp.focus();
  inp.selectionStart = inp.selectionEnd = text.length;
}

function clearWelcome() { document.getElementById("wEl")?.remove(); }
function clearMsgs(withWelcome) { document.getElementById("msgsInner").innerHTML = ""; if (withWelcome) showWelcome(); }

/* â•â• DOM HELPERS â•â• */
const AI_IC = `<img src="img/logo.png" alt="Nevro" style="width:18px;height:18px;object-fit:cover;border-radius:4px;" onerror="this.style.display='none';this.parentElement.innerHTML='<svg width=14 height=14 fill=none viewBox=\'0 0 24 24\' stroke=currentColor stroke-width=2><circle cx=12 cy=12 r=3/><path stroke-linecap=round stroke-linejoin=round d=\'M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0\'/></svg>'">`;

function addMsg(role, content) {
  const inner = document.getElementById("msgsInner");
  const isAI = role === "assistant";
  const d = document.createElement("div");
  d.className = "msg " + (isAI ? "ai" : "user");

  // build avatar
  const av = document.createElement("div");
  av.className = "msg-av " + (isAI ? "ai-av" : "u-av");
  av.innerHTML = isAI ? AI_IC : X(uInit);

  // build bubble â€” use formatted HTML for AI, escaped text for user
  const bubble = document.createElement("div");
  bubble.className = "msg-bubble";
  if (isAI) {
    bubble.innerHTML = fmt(content);
  } else {
    // user messages: escape HTML, convert newlines
    bubble.innerHTML = X(content).replace(/\n/g, "<br>");
  }

  d.appendChild(av);
  d.appendChild(bubble);
  inner.appendChild(d);

  if (isAI) setTimeout(() => { initCodeMirrors(bubble); flushCharts(); }, 80);
  scrollBot();
  return d;
}

function addTyping(searching = false) {
  const inner = document.getElementById("msgsInner");
  const d = document.createElement("div");
  d.className = "msg ai";
  const content = searching
    ? `<div class="search-indicator"><svg width="13" height="13" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-4.35-4.35"/></svg> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª...</div><div class="typing-dots"><span></span><span></span><span></span></div>`
    : `<div class="typing-dots"><span></span><span></span><span></span></div>`;
  d.innerHTML = `<div class="msg-av ai-av">${AI_IC}</div><div class="msg-bubble">${content}</div>`;
  inner.appendChild(d); scrollBot(); return d;
}

/* â•â• CODE MIRROR ENGINE â•â• */
window._codes  = {};
window._editors = {};
let blockCount = 0;

const LANG_META = {
  js:          { label:"JavaScript", color:"#f0db4f", cm:"javascript" },
  javascript:  { label:"JavaScript", color:"#f0db4f", cm:"javascript" },
  ts:          { label:"TypeScript", color:"#3178c6", cm:"text/typescript" },
  typescript:  { label:"TypeScript", color:"#3178c6", cm:"text/typescript" },
  jsx:         { label:"JSX",        color:"#61dafb", cm:"jsx" },
  tsx:         { label:"TSX",        color:"#61dafb", cm:"text/typescript-jsx" },
  html:        { label:"HTML",       color:"#e34c26", cm:"htmlmixed" },
  htm:         { label:"HTML",       color:"#e34c26", cm:"htmlmixed" },
  css:         { label:"CSS",        color:"#264de4", cm:"css" },
  scss:        { label:"SCSS",       color:"#c6538c", cm:"css" },
  python:      { label:"Python",     color:"#3572A5", cm:"python" },
  py:          { label:"Python",     color:"#3572A5", cm:"python" },
  sql:         { label:"SQL",        color:"#336791", cm:"sql" },
  bash:        { label:"Bash",       color:"#89e051", cm:"shell" },
  sh:          { label:"Shell",      color:"#89e051", cm:"shell" },
  php:         { label:"PHP",        color:"#8892be", cm:"php" },
  json:        { label:"JSON",       color:"#f0db4f", cm:"application/json" },
};

function getLangMeta(lang) {
  return LANG_META[(lang||"").toLowerCase()] || { label: lang || "code", color:"#63b3ed", cm:"text/plain" };
}

function makeCodeBlock(lang, raw) {
  const id   = "cb" + (++blockCount);
  const meta = getLangMeta(lang);

  window._codes      = window._codes      || {};
  window._langLabels = window._langLabels || {};
  window._codes[id]      = raw;
  window._langLabels[id] = meta.label;

  return `<div class="code-block" id="block-${id}">
    <div class="code-header">
      <div class="code-lang-badge">
        <div class="code-lang-dot" style="background:${meta.color}"></div>
        <span style="color:${meta.color}">${meta.label}</span>
      </div>
      <div class="code-actions">
        <button class="code-act-btn" id="copy-${id}" onclick="copyCode('${id}')">
          <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
          Ù†Ø³Ø®
        </button>
      </div>
    </div>
    <div class="cm-wrap" id="cm-${id}" data-lang="${meta.cm}" data-raw="${id}"></div>
  </div>`;
}

// Highlight.js â€” primary syntax highlighter (looks great, fast)
function initCodeMirrors(container) {
  container.querySelectorAll(".cm-wrap:not(.cm-ready)").forEach(el => {
    el.classList.add("cm-ready");
    const id  = el.dataset.raw;
    const raw = window._codes[id] || "";
    const langMeta = el.dataset.lang || "";

    // Map CodeMirror mode â†’ hljs language alias
    const modeToHljs = {
      "javascript":        "javascript",
      "text/javascript":   "javascript",
      "text/typescript":   "typescript",
      "text/x-python":     "python",
      "text/html":         "html",
      "htmlmixed":         "html",
      "text/css":          "css",
      "text/x-sql":        "sql",
      "text/x-sh":         "bash",
      "text/x-shellscript":"bash",
      "text/x-php":        "php",
      "application/json":  "json",
      "text/plain":        "",
    };
    const hljsLang = modeToHljs[langMeta] || "";

    el.style.direction  = "ltr";
    el.style.textAlign  = "left";
    el.style.overflow   = "auto";
    el.style.maxHeight  = "460px";

    // Escape raw code
    const escaped = raw
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;");

    let highlighted = "";
    if (typeof hljs !== "undefined" && hljsLang) {
      try {
        highlighted = hljs.highlight(raw, { language: hljsLang, ignoreIllegals: true }).value;
      } catch(_) {
        highlighted = escaped;
      }
    } else if (typeof hljs !== "undefined") {
      try {
        highlighted = hljs.highlightAuto(raw).value;
      } catch(_) {
        highlighted = escaped;
      }
    } else {
      highlighted = escaped;
    }

    const lineNums = raw.split("\n").map((_, i) =>
      `<span class="hljs-ln">${i + 1}</span>`
    ).join("\n");

    el.innerHTML = `
      <div class="hljs-block">
        <div class="hljs-gutter">${lineNums}</div>
        <pre class="hljs-code hljs"><code>${highlighted}</code></pre>
      </div>`;
  });
}

function copyCode(id) {
  const code = window._codes[id];
  if (code === undefined) return;
  if (navigator.clipboard?.writeText) {
    navigator.clipboard.writeText(code).then(() => flashCopy(id)).catch(() => fallbackCopy(id, code));
  } else {
    fallbackCopy(id, code);
  }
}

function fallbackCopy(id, code) {
  const ta = document.createElement("textarea");
  ta.value = code;
  ta.style.cssText = "position:fixed;top:-9999px;left:-9999px;opacity:0";
  document.body.appendChild(ta);
  ta.select();
  document.execCommand("copy");
  document.body.removeChild(ta);
  flashCopy(id);
}

function flashCopy(id) {
  const btn = document.getElementById("copy-" + id);
  if (!btn) return;
  btn.classList.add("copied");
  btn.innerHTML = `<svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>ØªÙ… Ø§Ù„Ù†Ø³Ø®!`;
  setTimeout(() => {
    btn.classList.remove("copied");
    btn.innerHTML = `<svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>Ù†Ø³Ø®`;
  }, 2500);
}


/* â•â• MARKDOWN + TABLE + CHART â•â• */
let chartCount = 0;

function esc(s) { return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }

function parseTable(md) {
  const lines = md.trim().split("\n");
  if (lines.length < 2 || !lines[1].match(/^\|?[\s\-:|]+\|/)) return null;
  const headers = lines[0].split("|").map(h => h.trim()).filter(Boolean);
  const rows = [];
  for (let i = 2; i < lines.length; i++) {
    const cells = lines[i].split("|").map(c => c.trim()).filter(Boolean);
    if (cells.length) rows.push(cells);
  }
  if (!headers.length || !rows.length) return null;
  const thead = headers.map(h => `<th>${h}</th>`).join("");
  const tbody = rows.map(r => "<tr>" + r.map(c => `<td>${c}</td>`).join("") + "</tr>").join("");
  return { headers, rows, html: `<div class="md-table-wrap"><table class="md-table"><thead><tr>${thead}</tr></thead><tbody>${tbody}</tbody></table></div>` };
}

function tryMakeChart(headers, rows) {
  if (!headers || headers.length < 2 || rows.length < 2) return null;
  const toNum = v => parseFloat(String(v).replace(/[,ØŒ%Ùª\s]/g,"").replace(/[^0-9.]/g,""));
  const isNum = v => !isNaN(toNum(v)) && String(v).trim() !== "";
  const numCols = headers.slice(1).map((_, ci) => rows.filter(r => isNum(r[ci+1]||"")).length >= Math.ceil(rows.length/2));
  if (!numCols.some(Boolean)) return null;
  const labels = rows.map(r => r[0]);
  const palette = [
    {bg:"rgba(99,179,237,.75)",border:"#63b3ed"},{bg:"rgba(159,122,234,.75)",border:"#9f7aea"},
    {bg:"rgba(104,211,145,.75)",border:"#68d391"},{bg:"rgba(246,173,85,.75)",border:"#f6ad55"},
    {bg:"rgba(246,135,179,.75)",border:"#f687b3"},
  ];
  const datasets = headers.slice(1).map((label, ci) => {
    if (!numCols[ci]) return null;
    const data = rows.map(r => { const n = toNum(r[ci+1]||"0"); return isNaN(n)?0:n; });
    const p = palette[ci%palette.length];
    return { label, data, backgroundColor:p.bg, borderColor:p.border, borderWidth:2, borderRadius:6, tension:0.4, fill:true, pointBackgroundColor:p.border, pointRadius:4 };
  }).filter(Boolean);
  if (!datasets.length) return null;
  const cid = "chart-"+(++chartCount);
  window._chartQueue = window._chartQueue || [];
  window._chartData  = window._chartData  || {};
  window._chartQueue.push({ cid });
  window._chartData[cid] = { labels, datasets, activeType:"bar", instance:null };
  return `<div class="chart-wrap">
    <div class="chart-header">
      <div class="chart-title">${headers[0]}</div>
      <div class="chart-type-btns">
        <button class="chart-type-btn active" onclick="switchChartType('${cid}','bar')"  id="btn-bar-${cid}">Ø¨Ø§Ø±</button>
        <button class="chart-type-btn"        onclick="switchChartType('${cid}','line')" id="btn-line-${cid}">Ø®Ø·</button>
        <button class="chart-type-btn"        onclick="switchChartType('${cid}','pie')"  id="btn-pie-${cid}">Ø¯Ø§Ø¦Ø±ÙŠ</button>
      </div>
    </div>
    <div class="chart-canvas-wrap"><canvas id="${cid}"></canvas></div>
  </div>`;
}

function buildChart(cid, type) {
  if (typeof Chart === "undefined") return;
  const state = (window._chartData||{})[cid];
  if (!state) return;
  const canvas = document.getElementById(cid);
  if (!canvas) return;
  if (state.instance) { state.instance.destroy(); state.instance = null; }
  let data = JSON.parse(JSON.stringify({ labels:state.labels, datasets:state.datasets }));
  if (type === "pie" && data.datasets.length) {
    const d = data.datasets[0];
    const pal = ["rgba(99,179,237,.8)","rgba(159,122,234,.8)","rgba(104,211,145,.8)","rgba(246,173,85,.8)","rgba(246,135,179,.8)"];
    d.backgroundColor = data.labels.map((_,i) => pal[i%pal.length]);
    d.borderColor = "#0c1124"; d.borderWidth = 2;
    data.datasets = [d];
  }
  const isLight = document.body.getAttribute("data-theme") === "light";
  const tc = isLight?"#64748b":"#8b949e", gc = isLight?"rgba(0,0,0,.05)":"rgba(255,255,255,.05)", lc = isLight?"#374151":"#a9b1d6";
  state.instance = new Chart(canvas, {
    type, data,
    options: {
      responsive:true, maintainAspectRatio:true,
      animation:{ duration:500, easing:"easeInOutQuart" },
      plugins:{
        legend:{ display: type==="pie"||data.datasets.length>1, labels:{ color:lc, font:{family:"Tajawal",size:12}, padding:16, usePointStyle:true }},
        tooltip:{ backgroundColor:"rgba(12,17,36,.92)", titleColor:"#63b3ed", bodyColor:"#eef2ff", borderColor:"rgba(99,179,237,.3)", borderWidth:1, padding:10,
          titleFont:{family:"Tajawal",size:12,weight:"bold"}, bodyFont:{family:"Tajawal",size:12},
          callbacks:{ label: ctx => ` ${ctx.dataset.label||""}: ${ctx.parsed.y??ctx.parsed}` }}
      },
      scales: type==="pie" ? {} : {
        x:{ ticks:{color:tc,font:{family:"Tajawal",size:11}}, grid:{color:gc} },
        y:{ ticks:{color:tc,font:{family:"Tajawal",size:11}}, grid:{color:gc}, beginAtZero:true }
      }
    }
  });
  state.activeType = type;
  ["bar","line","pie"].forEach(t => {
    const b = document.getElementById("btn-"+t+"-"+cid);
    if (b) b.className = "chart-type-btn"+(t===type?" active":"");
  });
}

function switchChartType(cid, type) { buildChart(cid, type); }

function flushCharts() {
  if (!window._chartQueue?.length) return;
  if (typeof Chart === "undefined") { setTimeout(flushCharts, 400); return; }
  window._chartQueue.forEach(({ cid }) => {
    const state = (window._chartData||{})[cid];
    const canvas = document.getElementById(cid);
    if (!canvas || canvas.dataset.drawn || !state) return;
    canvas.dataset.drawn = "1";
    buildChart(cid, "bar");
  });
  window._chartQueue = [];
}

function fmtInline(s) {
  return s
    .replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>")
    .replace(/\*(.+?)\*/g,     "<em>$1</em>")
    .replace(/~~(.+?)~~/g,     "<del>$1</del>");
}

function fmt(t) {
  blockCount = 0;
  window._chartQueue = [];
  window._chartData  = window._chartData || {};
  const blocks = [];

  // â”€â”€ 1. Fenced code blocks â”€â”€
  let s = t.replace(/```([a-zA-Z0-9]*)\r?\n?([\s\S]*?)```/g, (_, lang, code) => {
    const ph = "\x00B" + blocks.length + "\x00";
    blocks.push(makeCodeBlock(lang, code.replace(/\r\n/g, "\n").trim()));
    return ph;
  });

  // â”€â”€ 2. Markdown tables â”€â”€
  s = s.replace(/((?:\|.+\|\r?\n)+\|[\s\-:|]+\|\r?\n(?:\|.+\|\r?\n?)*)/g, match => {
    const parsed = parseTable(match);
    if (!parsed) return match;
    const chart = tryMakeChart(parsed.headers, parsed.rows) || "";
    const ph = "\x00B" + blocks.length + "\x00";
    blocks.push(parsed.html + chart);
    return ph;
  });

  // â”€â”€ 3. Inline code â”€â”€
  s = s.replace(/`([^`\n]+)`/g, (_, c) => {
    const ph = "\x00B" + blocks.length + "\x00";
    blocks.push(`<code>${esc(c)}</code>`);
    return ph;
  });

  // â”€â”€ 4. Line by line â”€â”€
  const lines = s.split("\n");
  const out = [];
  let listType = "";

  const closeList = () => { if (listType) { out.push(`</${listType}>`); listType = ""; } };

  for (const raw of lines) {
    const line = raw;
    // headings
    if (/^### /.test(line))          { closeList(); out.push(line.replace(/^### (.+)/, m => `<h3>${fmtInline(m.slice(4))}</h3>`)); continue; }
    if (/^## /.test(line))           { closeList(); out.push(line.replace(/^## (.+)/,  m => `<h2>${fmtInline(m.slice(3))}</h2>`)); continue; }
    if (/^# /.test(line))            { closeList(); out.push(line.replace(/^# (.+)/,   m => `<h1>${fmtInline(m.slice(2))}</h1>`)); continue; }
    // hr
    if (/^-{3,}$/.test(line.trim())){ closeList(); out.push("<hr>"); continue; }
    // blockquote
    if (/^> /.test(line))           { closeList(); out.push(`<blockquote>${fmtInline(line.slice(2))}</blockquote>`); continue; }
    // bullet list
    if (/^[*\-] /.test(line)) {
      if (listType !== "ul") { closeList(); out.push("<ul>"); listType = "ul"; }
      out.push(`<li>${fmtInline(line.slice(2))}</li>`); continue;
    }
    // numbered list
    if (/^\d+\. /.test(line)) {
      if (listType !== "ol") { closeList(); out.push("<ol>"); listType = "ol"; }
      out.push(`<li>${fmtInline(line.replace(/^\d+\.\s+/, ""))}</li>`); continue;
    }
    // empty line
    if (line.trim() === "") { closeList(); out.push("<br>"); continue; }
    // close list on non-list line
    closeList();
    // block placeholder â€” no extra <br>
    if (line.includes("\x00B")) { out.push(line); continue; }
    out.push(fmtInline(line) + "<br>");
  }
  closeList();

  // â”€â”€ 5. Restore blocks â”€â”€
  let result = out.join("").replace(/\x00B(\d+)\x00/g, (_, i) => blocks[+i] || "");

  return result;
}

/* â•â• TIER SELECTOR â•â• */
let selectedTier = "pro"; // Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Pro

function toggleModelDrop() {
  const drop = document.getElementById("modelDrop");
  const btn  = document.getElementById("modelDropBtn");
  const isOpen = drop.classList.contains("open");
  if (isOpen) { drop.classList.remove("open"); btn.classList.remove("open"); }
  else         { drop.classList.add("open");    btn.classList.add("open"); }
}

function selectTier(tier) {
  selectedTier = tier;
  const isPro = tier === "pro";
  const dot   = isPro ? "#f6ad55" : "#63b3ed";
  // Dot only - no model name shown
  document.getElementById("modelDot").style.background = dot;
  if (document.getElementById("activeModelDot"))
    document.getElementById("activeModelDot").style.background = dot;
  // Checkmarks
  document.getElementById("checkV1").style.display  = isPro ? "none"  : "block";
  document.getElementById("checkPro").style.display = isPro ? "block" : "none";
  // Active state
  document.getElementById("optV1").classList.toggle("active", !isPro);
  document.getElementById("optPro").classList.toggle("active",  isPro);
  // Close dropdown
  document.getElementById("modelDrop").classList.remove("open");
  document.getElementById("modelDropBtn").classList.remove("open");
}

// Close on outside click
document.addEventListener("click", e => {
  if (!e.target.closest(".model-drop-wrap")) {
    document.getElementById("modelDrop")?.classList.remove("open");
    document.getElementById("modelDropBtn")?.classList.remove("open");
  }
});

function updateProCount(used, limit) {
  const left = Math.max(0, limit - used);
  const el = document.getElementById("proCount");
  if (!el) return;
  el.textContent = left;
  el.className = "pro-count" + (left === 0 ? " empty" : "");
  const optPro = document.getElementById("optPro");
  if (left === 0) {
    // disable Pro option visually
    if (optPro) { optPro.style.opacity = "0.4"; optPro.style.pointerEvents = "none"; }
    if (selectedTier === "pro") {
      selectTier("v1");
      showPopup("pro_exhausted");
    }
  } else {
    if (optPro) { optPro.style.opacity = ""; optPro.style.pointerEvents = ""; }
  }
}

function scrollBot() { const w = document.getElementById("msgsWrap"); setTimeout(() => w.scrollTop = w.scrollHeight, 40); }
function setLoad(on) {
  loading = on;
  const btn = document.getElementById("sendBtn"), icon = btn.querySelector("svg"), sp = document.getElementById("sendSp");
  btn.disabled = on; icon.style.display = on ? "none" : ""; sp.style.display = on ? "block" : "none";
}
function resize(el) { el.style.height = "auto"; el.style.height = Math.min(el.scrollHeight, 160) + "px"; }
function onKey(e) { if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); send(); } }

/* â•â• POPUP â•â• */
function showPopup(type) {
  const titles = {
    daily:         "ÙˆØµÙ„Øª Ù„Ù„Ø­Ø¯ Ø§Ù„ÙŠÙˆÙ…ÙŠ! ğŸ“…",
    total:         "ÙˆØµÙ„Øª Ù„Ù„Ø­Ø¯ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ! ğŸ”’",
    search:        "Ø§Ù†ØªÙ‡Øª Ø£Ø¨Ø­Ø§Ø«Ùƒ Ø§Ù„ÙŠÙˆÙ…! ğŸ”",
    pro_exhausted: "Ø§Ù†ØªÙ‡Øª Ø±Ø³Ø§ÙŠÙ„ Pro Ø§Ù„ÙŠÙˆÙ…! âš¡",
  };
  const subs = {
    daily:         "Ø§Ø³ØªØ®Ø¯Ù…Øª ÙƒÙ„ Ù…Ø­Ø§Ø¯Ø«Ø§ØªÙƒ Ù„Ù„ÙŠÙˆÙ… â€” Ø§Ù„Ø­Ø¯ Ù‡Ùˆ <strong>" + DAILY + " Ù…Ø­Ø§Ø¯Ø«Ø§Øª</strong>. ØªØªØ¬Ø¯Ø¯ ØºØ¯Ø§Ù‹.",
    total:         "ÙˆØµÙ„Øª Ù„Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ ÙˆÙ‡Ùˆ <strong>" + TOTAL + " Ù…Ø­Ø§Ø¯Ø«Ø©</strong> ÙÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ.",
    search:        "Ø§Ø³ØªØ®Ø¯Ù…Øª Ø§Ù„Ù€ <strong>" + SEARCH_LIMIT + " Ø£Ø¨Ø­Ø§Ø«</strong> Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ù„ÙŠÙˆÙ…. ØªØªØ¬Ø¯Ø¯ ØºØ¯Ø§Ù‹.<br><small style='color:var(--text3);font-size:11px'>Ø³ÙŠØ³ØªÙ…Ø± Ø§Ù„Ø±Ø¯ Ø¨Ø¯ÙˆÙ† Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª</small>",
    pro_exhausted: "Ø§Ø³ØªØ®Ø¯Ù…Øª Ø§Ù„Ù€ <strong>" + PRO_LIMIT + " Ø±Ø³Ø§ÙŠÙ„ Pro</strong> Ø§Ù„Ù…ØªØ§Ø­Ø© Ø§Ù„ÙŠÙˆÙ…. ØªØªØ¬Ø¯Ø¯ ØºØ¯Ø§Ù‹.<br><small style='color:var(--text3);font-size:11px'>ØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù„Ù€ Nevro V1</small>",
  };
  document.getElementById("popTitle").textContent = titles[type] || "ØªÙ†Ø¨ÙŠÙ‡";
  document.getElementById("popSub").innerHTML     = subs[type]   || "";
  document.getElementById("popup").classList.add("show");
}
function closePopup() { document.getElementById("popup").classList.remove("show"); }
document.getElementById("popup").addEventListener("click", e => { if (e.target === e.currentTarget) closePopup(); });

/* â•â• SIDEBAR / THEME â•â• */
function openSb()  { document.getElementById("sb").classList.add("open"); document.getElementById("sbOv").classList.add("open"); }
function closeSb() { document.getElementById("sb").classList.remove("open"); document.getElementById("sbOv").classList.remove("open"); }
function toggleTheme() {
  const l = document.body.getAttribute("data-theme") !== "light";
  document.body.setAttribute("data-theme", l ? "light" : "");
  document.getElementById("themeBtn").innerHTML = l
    ? `<svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>`
    : `<svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 12.79A9 9 0 1111.21 3a7 7 0 009.79 9.79z"/></svg>`;
}

</script>
</body>
  </html>
